<section class="page chat-page">
    <header class="page-header">
        <h1>Chat</h1>
        <p class="page-description">Interact with the chatbot</p>
    </header>
    
    <div class="page-content-wrapper">
        <!-- Project Selection -->
        <div class="chat-project-selector">
            <label for="project-select">Select a Project:</label>
            <select id="project-select" class="project-select">
                <option value="">-- Select a project --</option>
            </select>
            <div id="no-projects-message" class="no-projects-message" style="display: none;">
                No projects available. Please create a project in the Admin page first.
            </div>
        </div>

        <!-- Chat Container -->
        <div class="chat-container" id="chat-container">
            <div class="chat-messages" id="chat-messages">
                <div class="message bot-message">
                    <p>Hello! How can I assist you today?</p>
                </div>
            </div>
            <div class="chat-input-area">
                <input 
                    type="text" 
                    id="chat-input" 
                    class="chat-input" 
                    placeholder="Type your message... (Press Enter or click Send)"
                    disabled
                >
                <button id="chat-send-btn" class="chat-send-btn" disabled>Send</button>
            </div>
        </div>
    </div>
</section>

<script>
    // Use global basePath and buildUrl from app.js (avoid redeclaration)
    // If not available yet, fall back to getting from DOM
    const getBasePath = () => window.basePath || document.documentElement.getAttribute('data-base-path') || '';
    const getBuildUrl = () => window.buildUrl || ((path) => {
        const bp = getBasePath();
        if (bp && !path.startsWith('/')) {
            return bp + '/' + path;
        }
        return path;
    });

    // Global chat state
    let chatHistory = [];
    let currentProjectId = null;
    let isProcessing = false;
    let chatPageInitialized = false; // Flag to prevent re-initialization

    function initializeChatPage() {
        // Only initialize once to avoid resetting the dropdown
        if (chatPageInitialized) {
            console.log('[CHAT] Page already initialized, skipping...');
            return;
        }
        
        chatPageInitialized = true;
        loadProjectsForChat();
        setupChatListeners();
        console.log('[CHAT] Page initialized, basePath:', getBasePath());
    }

    // Load projects on page load (both initial and HTMX dynamic load)
    // Use a single approach: DOMContentLoaded for initial load
    document.addEventListener('DOMContentLoaded', function() {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeChatPage);
        } else {
            initializeChatPage();
        }
    });
    
    // Also initialize when HTMX loads the page
    document.addEventListener('pageLoaded', function(e) {
        if (e.detail && e.detail.url && e.detail.url.includes('/chat')) {
            // Reset flag when returning to chat page
            chatPageInitialized = false;
            initializeChatPage();
        }
    });

    // Load projects from database
    function loadProjectsForChat() {
        fetch(getBuildUrl()('api/projects'))
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const projectItems = doc.querySelectorAll('.project-item');
                
                const projectSelect = document.getElementById('project-select');
                const noProjectsMessage = document.getElementById('no-projects-message');
                const chatInput = document.getElementById('chat-input');
                const sendBtn = document.getElementById('chat-send-btn');
                
                // Clear existing options (except the placeholder)
                projectSelect.innerHTML = '<option value="">-- Select a project --</option>';
                
                if (projectItems.length === 0) {
                    // No projects available
                    noProjectsMessage.style.display = 'block';
                    chatInput.disabled = true;
                    sendBtn.disabled = true;
                    console.log('[CHAT] No projects available');
                } else {
                    // Add each project as option
                    noProjectsMessage.style.display = 'none';
                    projectItems.forEach(item => {
                        const projectName = item.querySelector('.project-name')?.textContent.trim() || 'Unknown';
                        const projectId = item.getAttribute('data-project-id');
                        
                        if (projectId && projectName) {
                            const option = document.createElement('option');
                            option.value = projectId;
                            option.textContent = projectName;
                            projectSelect.appendChild(option);
                        }
                    });
                    console.log(`[CHAT] Loaded ${projectItems.length} projects`);
                }
            })
            .catch(error => {
                console.error('[CHAT] Error loading projects:', error);
                const projectSelect = document.getElementById('project-select');
                projectSelect.innerHTML = '<option value="">Error loading projects</option>';
            });
    }

    // Setup chat event listeners
    function setupChatListeners() {
        const projectSelect = document.getElementById('project-select');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('chat-send-btn');
        
        // Handle project selection change
        projectSelect.addEventListener('change', (e) => {
            currentProjectId = e.target.value ? parseInt(e.target.value) : null;
            const isSelected = projectSelect.value !== '';
            chatInput.disabled = !isSelected;
            sendBtn.disabled = !isSelected || isProcessing;
            
            // Clear chat when switching projects
            if (isSelected) {
                clearChatMessages();
                chatHistory = [];
                console.log(`[CHAT] Project selected: ${currentProjectId}`);
            }
        });
        
        // Send message on Enter key
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey && !isProcessing) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Send message on Send button click
        sendBtn.addEventListener('click', sendMessage);
    }

    // Send message function
    function sendMessage() {
        const chatInput = document.getElementById('chat-input');
        const messageText = chatInput.value.trim();
        const sendBtn = document.getElementById('chat-send-btn');
        
        if (messageText === '' || !currentProjectId || isProcessing) return;
        
        console.log(`[CHAT] Sending message to project ${currentProjectId}: ${messageText}`);
        
        const chatMessages = document.getElementById('chat-messages');
        
        // Add user message to display
        addMessageToDisplay('user', messageText);
        
        // Clear input
        chatInput.value = '';
        
        // Set processing state
        isProcessing = true;
        sendBtn.disabled = true;
        
        // Add to chat history
        chatHistory.push({ role: 'user', content: messageText });
        
        // Auto-scroll to bottom
        scrollToBottom();
        
        // Call backend API
        fetch(getBuildUrl()('api/chat/send'), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                project_id: currentProjectId,
                message: messageText,
                chat_history: chatHistory
            })
        })
        .then(response => response.json())
        .then(data => {
            isProcessing = false;
            sendBtn.disabled = false;
            
            if (data.success) {
                const answer = data.answer || 'No answer generated';
                const sources = data.sources || [];
                
                // Format answer with sources
                let formattedAnswer = answer;
                if (sources.length > 0) {
                    formattedAnswer += '\n\n---\n**Sources:**\n';
                    sources.forEach((source, index) => {
                        formattedAnswer += `${index + 1}. ${source.source}`;
                        if (source.score) {
                            formattedAnswer += ` (relevance: ${(source.score * 100).toFixed(1)}%)`;
                        }
                        formattedAnswer += '\n';
                    });
                }
                
                // Add assistant message to display
                addMessageToDisplay('assistant', formattedAnswer);
                
                // Add to chat history (without sources for next turn)
                chatHistory.push({ role: 'assistant', content: answer });
                
                console.log(`[CHAT] Answer received with ${sources.length} sources`);
            } else {
                const errorMsg = data.error || 'An error occurred';
                addMessageToDisplay('assistant', `Error: ${errorMsg}`);
                console.error(`[CHAT] Error:`, errorMsg);
            }
            
            scrollToBottom();
        })
        .catch(error => {
            isProcessing = false;
            sendBtn.disabled = false;
            console.error('[CHAT] Network error:', error);
            addMessageToDisplay('assistant', `Network error: ${error.message}`);
            scrollToBottom();
        });
    }

    // Add message to display
    function addMessageToDisplay(role, text) {
        const chatMessages = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}-message`;
        
        // Convert text to HTML with line breaks and basic formatting
        const formattedText = escapeHtml(text)
            .replace(/\n/g, '<br>')
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/---/g, '<hr>');
        
        messageDiv.innerHTML = `<p>${formattedText}</p>`;
        chatMessages.appendChild(messageDiv);
    }

    // Clear chat messages
    function clearChatMessages() {
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.innerHTML = '<div class="message bot-message"><p>Hello! How can I assist you today?</p></div>';
    }

    // Auto-scroll to bottom
    function scrollToBottom() {
        const chatMessages = document.getElementById('chat-messages');
        setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 0);
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
</script>
